/*
 *  MLToolKit
 *
 *  Created by Hong Lu on 07/07/2011.
 *
 */

#include "kiss_fft.h"
#include "kiss_fftr.h"
#include <math.h>
#include "mfcc.h"
#include "classifier.h"
#include "feature_audio.h"
#include "features.h"
#include <android/log.h>
#define LOG_TAG "stresstoolkit"
#define LOGE(...) __android_log_print(ANDROID_LOG_ERROR, LOG_TAG, __VA_ARGS__) 
#define LOGD(...) __android_log_print(ANDROID_LOG_DEBUG, LOG_TAG, __VA_ARGS__)
#define DEBUG 1

#define MAX_FFT 2048
#define PITCH_MIN 32
#define PITCH_MAX 100
#define FS 8000
//the split for high frequency
#define LOW_FREQ 16
//mfcc bank
#define NBANK 24
#define NFFT 256
#define NFFT_SQUARE 65536
#define NMFCC 20



const double bankFilter[NBANK][NFFT/2] = {0,0.0035540369188138774131,0.0071080738376277548263,0.010662110756441632239,0.0071126292612726680839,0.0035585923424587911044,4.5554236449135278338e-06,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.0035517592069914216517,0.0071057961258052994985,0.010659833044619176912,0.007114906973095124279,0.0035608700542812438301,6.833135467363831854e-06,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.0035494814951689663239,0.0071035184139828450381,0.010657555332796725053,0.0071171846849175778721,0.0035631477661037021937,9.1108472898270505855e-06,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.0035472037833465105625,0.0071012407021603845061,0.010655277620974259317,0.0071194623967400366693,0.0035654254779261605572,1.138855911228381662e-05,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.0035449260715240521989,0.0070989629903379309131,0.010652999909151810928,0.0071217401085624954665,0.0035677031897486115482,1.3666270934727678955e-05,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.0035426483597015973048,0.0070966852785154781874,0.010650722197329357335,0.0071240178203849438554,0.0035699809015710738148,1.5943982757203777669e-05,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.0035403706478791415434,0.0070944075666930107166,0.010648444485506879456,0.0071262955322074095915,0.003572258613393531311,1.8221694579654111335e-05,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.0035380929360566779757,0.0070921298548705588582,0.010646166773684439741,0.0071285732440298675214,0.0035745363252159857714,2.0499406402104434837e-05,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.0035358152242342256837,0.0070898521430481061326,0.010643889061861984413,0.0071308509558523185123,0.0035768140370384428339,2.2777118224567626464e-05,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.0035051902230167865035,0.0070307153989372607114,0.010556240574857734052,0.0071316603898865316494,0.0036622510559946482023,0.00019284172210276494491,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.0032558071995196016801,0.0065326148095690324269,0.0098094224196184614389,0.0071800151382823470397,0.0042029987776567414096,0.0012259824170311353457,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.0025533086068624203518,0.0052568916738139773517,0.0079604747407655343516,0.0076302241583084233489,0.0051758418741338109437,0.002721459589959197671,0.00026707730578458461525,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.0013105634168706877581,0.0035387148173240731003,0.0057668662177774582256,0.0079950176182308433509,0.0064348151985020524482,0.0044120420162828298191,0.0023892688340636067564,0.00036649565184438396464,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.0016365030191621704209,0.003472828569514243343,0.0053091541198663156145,0.0071454796702183891871,0.0061131767615908274086,0.0044461131696282947187,0.0027790495776657620289,0.001111985985703229339,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.0012391976454165960775,0.0027526008756413125091,0.0042660041058660280733,0.0057794073360907440712,0.0063314309731881185037,0.0049575245737578151756,0.0035836181743275105464,0.0022097117748972067847,0.00083580537546690258921,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.00041529927810125512799,0.0016625668646223091662,0.0029098344511433631501,0.0041571020376644169173,0.0054043696241854706844,0.0057196606048304865846,0.0045873589916848407297,0.0034550573785391948747,0.0023227557653935485861,0.0011904541522479022975,5.8152539102256259557e-05,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.0004025976985516386609,0.0014305302424481350886,0.0024584627863446311367,0.0034863953302411276186,0.0045143278741376236668,0.0055422604180341205823,0.0047097954461289455452,0.0037766118292072536726,0.0028434282122855613663,0.0019102445953638688431,0.00097706097844217675366,4.3877361520484535441e-05,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.00080365939824090419988,0.0016508275009162658251,0.0024979956035916274504,0.0033451637062669888588,0.0041923318089423502672,0.0050394999116177121093,0.0043464133249626214078,0.0035773323197066130875,0.0028082513144506043336,0.002039170309194596447,0.0012700893039385881267,0.00050100829868257969798,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.00066536326040601021046,0.0013635547890739048525,0.0020617463177417996029,0.0027599378464096941364,0.0034581293750775891037,0.0041563209037454836373,0.0043902176623344824763,0.0037563814248352304058,0.0031225451873359792027,0.0024887089498367271322,0.0018548727123374757122,0.0012210364748382240754,0.00058720023733897243855,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.00020056727250961507215,0.00077598012051955874997,0.0013513929685295023465,0.0019268058165394460514,0.0025022186645493899732,0.0030776315125593334612,0.0036530443605692769493,0.0041476849015115281952,0.0036253103099904704365,0.0031029357184694122442,0.0025805611269483544855,0.0020581865354272958595,0.0015358119439062381008,0.0010134373523851799084,0.0004910627608641218245,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3.4892233052987712725e-05,0.00050911733040791468975,0.00098334242776284153803,0.0014575675251177686031,0.0019317926224726956683,0.0024060177198276222997,0.0028802428171825493648,0.0033544679145374764299,0.0037744617572397424869,0.0033439480098033432659,0.0029134342623669431775,0.0024829205149305439565,0.0020524067674941443018,0.0016218930200577446471,0.0011913792726213449924,0.00076086552518494555454,0.00033035177774854589984,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2.3426959620092731442e-05,0.00041425841870041177481,0.00080508987778073074024,0.0011959213368610498683,0.001586752795941368888,0.0019775842550216879076,0.0023684157141020071441,0.0027592471731823259469,0.0031500786322626447497,0.0033674322342298473876,0.0030126253777323854129,0.0026578185212349230045,0.0023030116647374601624,0.0019482048082399981877,0.0015933979517425357793,0.0012385910952450733709,0.00088378423874761085407,0.00052897738225014866251,0.00017417052575268622701,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,7.4939419705455850374e-05,0.00039704221489456970658,0.00071914501008368348148,0.0010412478052727973648,0.0013633506004619110313,0.0016854533956510251314,0.0020075561908401385811,0.0023296589860292526812,0.0026517617812183663477,0.0029738645764074804478,0.0029831100698478659611,0.002690696863144849231,0.0023982836564418329346,0.0021058704497388162045,0.001813457243035800125,0.0015210440363327836118,0.0012286308296297670985,0.00093621762292675058531,0.0006438044162237341805,0.00035139120952071766727,5.8978002817701242132e-05,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.00013514891775713350121,0.00040060915197875516863,0.00066606938620037694446,0.00093152962042199866609,0.0011969898546436204961,0.0014624500888652421093,0.0017279103230868639394,0.0019933705573084853357,0.0022588307915301073826,0.0025242910257517289958,0.002789751259973350609,0.0026509079539292434123,0.0024099163217538581601,0.0021689246895784724742,0.0019279330574030865714,0.0016869414252277006687,0.0014459497930523147659,0.00120495816087692908,0.00096396652870154328572,0.00072297489652615738297,0.00048198326435077164286,0.00024099163217538582143,};
const int filterInd[NBANK][2] = {2,7,5,10,8,13,11,16,14,19,17,22,20,25,23,28,26,31,29,34,32,37,35,41,38,45,42,49,46,54,50,60,55,66,61,72,67,79,73,87,80,96,88,106,97,117,107,128,};
const double dct[NMFCC][NBANK] = {0.28867513459481286553,0.28867513459481286553,0.28867513459481286553,0.28867513459481286553,0.28867513459481286553,0.28867513459481286553,0.28867513459481286553,0.28867513459481286553,0.28867513459481286553,0.28867513459481286553,0.28867513459481286553,0.28867513459481286553,0.28867513459481286553,0.28867513459481286553,0.28867513459481286553,0.28867513459481286553,0.28867513459481286553,0.28867513459481286553,0.28867513459481286553,0.28867513459481286553,0.28867513459481286553,0.28867513459481286553,0.28867513459481286553,0.28867513459481286553,0.73899979034524421184,0.72635529904298701265,0.70128266719036946863,0.66421089446983694327,0.61577428919087451309,0.55680161509896952676,0.48830191099814873601,0.41144722581728310207,0.32755256452796138733,0.23805338804483841542,0.14448105209140002514,0.048436605278962506504,-0.048436605278962256704,-0.14448105209139977534,-0.23805338804483816562,-0.32755256452796116529,-0.41144722581728271349,-0.48830191099814845845,-0.55680161509896941574,-0.61577428919087429104,-0.6642108944698366102,-0.70128266719036946863,-0.72635529904298701265,-0.73899979034524421184,1.1731728933695686479,1.0932230994463063567,0.93877195793237122601,0.7203450588793576248,0.45282783449021102307,0.15445114151393549151,-0.15445114151393507518,-0.45282783449021063449,-0.72034505887935729174,-0.93877195793237089294,-1.0932230994463063567,-1.1731728933695686479,-1.1731728933695688699,-1.0932230994463065787,-0.93877195793237144805,-0.72034505887935795787,-0.45282783449021163369,-0.15445114151393640745,0.1544511415139349364,0.4528278344902101904,0.7203450588793566256,0.93877195793237078192,1.0932230994463061347,1.1731728933695684258,1.5769016378304014925,1.3368326581196658953,0.89324302462843430117,0.3136652379057053297,-0.31366523790570510766,-0.89324302462843363504,-1.3368326581196661174,-1.5769016378304014925,-1.5769016378304014925,-1.3368326581196663394,-0.89324302462843419015,-0.3136652379057058293,0.31366523790570527419,0.89324302462843352401,1.3368326581196658953,1.5769016378304012704,1.5769016378304014925,1.3368326581196663394,0.89324302462843430117,0.31366523790570605135,-0.31366523790570366437,-0.89324302462843341299,-1.3368326581196658953,-1.5769016378304014925,1.9371065815609951333,1.4180604373787137895,0.51904614418228178785,-0.51904614418228101069,-1.4180604373787135675,-1.9371065815609946892,-1.9371065815609951333,-1.4180604373787144556,-0.51904614418228289807,0.51904614418228034456,1.4180604373787133454,1.9371065815609944671,1.9371065815609951333,1.4180604373787153438,0.51904614418228312012,-0.51904614418228023354,-1.4180604373787120132,-1.9371065815609940231,-1.9371065815609951333,-1.4180604373787155659,-0.51904614418228489647,0.51904614418228001149,1.4180604373787117911,1.9371065815609940231,2.2424605130248038698,1.3156665639340467955,-0.1548835866116687332,-1.5614213855233545214,-2.3226341570025756944,-2.123917747941666434,-1.0474003226641430686,0.46200065872623657937,1.7804598542985643483,2.3630668865981871996,1.9690341613299986445,0.76121277147922328243,-0.76121277147921584394,-1.9690341613299939816,-2.3630668865981871996,-1.7804598542985681231,-0.46200065872624218599,1.0474003226641377395,2.1239177479416642136,2.3226341570025761385,1.5614213855233602946,0.1548835866116754223,-1.3156665639340412444,-2.2424605130248020934,2.4838522902623632049,1.0288453055581445739,-1.0288453055581443518,-2.4838522902623632049,-2.483852290262363649,-1.0288453055581459061,1.028845305558145018,2.4838522902623627608,2.4838522902623632049,1.0288453055581461282,-1.0288453055581445739,-2.4838522902623627608,-2.4838522902623632049,-1.0288453055581465723,1.0288453055581443518,2.4838522902623627608,2.4838522902623632049,1.0288453055581467943,-1.0288453055581441298,-2.4838522902623627608,-2.4838522902623649813,-1.0288453055581472384,1.0288453055581439077,2.483852290262363649,2.6547557631691911517,0.57747006094283603872,-1.9516727641505633439,-2.9536762626662294018,-1.6444956008290987359,0.95146527874767539146,2.80292632631433003,2.4611615928788759255,0.19359417029031783519,-2.225456265371492659,-2.9031380428982398456,-1.3091806618371337745,1.3091806618371266691,2.9031380428982380693,2.2254562653714979881,-0.19359417029031000812,-2.4611615928788745933,-2.8029263263143309182,-0.95146527874768271893,1.6444956008290967375,2.9536762626662289577,1.9516727641505660085,-0.57747006094282637978,-2.6547557631691889313,2.75148798722492538,1.9454400192665258678e-16,-2.751487987224924936,-2.7514879872249258241,-5.8363200577995773569e-16,2.7514879872249244919,2.7514879872249267123,3.7945913330818749986e-15,-2.7514879872249227155,-2.7514879872249267123,-1.3618080134865680828e-15,2.7514879872249227155,2.7514879872249267123,7.3946386642370965969e-15,-2.7514879872249222714,-2.7514879872249271564,-7.7837266680904018198e-15,2.7514879872249191628,2.7514879872249271564,8.1728146719437070427e-15,-2.7514879872249191628,-2.7514879872249280446,-8.5619026757970122655e-15,2.7514879872249191628,2.7733457150567422111,-0.65071880031088524809,-3.2713843230716683763,-1.8530903623659380486,1.8530903623659367163,3.2713843230716683763,0.6507188003108872465,-2.7733457150567417671,-2.7733457150567430993,0.65071880031088191743,3.2713843230716683763,1.8530903623659389368,-1.8530903623659358281,-3.2713843230716692645,-0.65071880031089135432,2.7733457150567377703,2.7733457150567404348,-0.65071880031088658036,-3.2713843230716683763,-1.8530903623659398249,1.853090362365935162,3.2713843230716692645,0.65071880031089257557,-2.7733457150567373262,2.722614405526194048,-1.3132854842848793453,-3.4024209955054227628,-0.44793722190208568046,3.170551627428275232,2.0891355112205456379,-2.0891355112205367561,-3.1705516274282787847,0.44793722190207757583,3.4024209955054214305,1.3132854842848891153,-2.7226144055261882748,-2.7226144055262020416,1.3132854842848682431,3.4024209955054236509,0.44793722190209389611,-3.1705516274282725675,-2.0891355112205496347,2.0891355112205345357,3.1705516274282792288,-0.44793722190206336498,-3.4024209955054196541,-1.3132854842848964427,2.7226144055261833898,2.6044494914127840346,-1.9245517415256614413,-3.1068583125164117575,1.1134989709256979395,3.3975398739481668109,-0.22656308560119903239,-3.4566847076704672048,-0.67581269959381973234,3.2802621910065976607,1.5321329661448084281,-2.8802952269152051201,-2.2840409030224706477,2.2840409030224675391,2.8802952269152148901,-1.5321329661447986581,-3.280262191006598993,0.67581269959380319001,3.4566847076704676489,0.22656308560120674844,-3.3975398739481637023,-1.1134989709257079316,3.1068583125164077607,1.9245517415256758742,-2.6044494914127840346,2.426635158549948823,-2.4266351585499483789,-2.426635158549948823,2.4266351585499479349,2.426635158549948823,-2.4266351585499457144,-2.4266351585499470467,2.4266351585499452703,2.4266351585499474908,-2.4266351585499448262,-2.4266351585499479349,2.4266351585499448262,2.4266351585499483789,-2.4266351585499443821,-2.426635158549948823,2.4266351585499439381,2.426635158549948823,-2.4266351585499439381,-2.426635158549948823,2.426635158549943494,2.4266351585499581489,-2.426635158549943494,-2.4266351585499501553,2.4266351585499514876,2.1992311733251943551,-2.773345715056741323,-1.4752426615328919635,3.1584613294776668901,0.6507188003108902441,-3.3283330238988271255,0.21815047178863605781,3.2713843230716692645,-1.0721531497464666938,-2.9914961868453890936,1.8530903623659358281,2.5077425291667858609,-2.5077425291667743146,-1.8530903623659498169,2.9914961868453815441,1.0721531497464831251,-3.2713843230716661559,-0.21815047178865909494,3.3283330238988275696,-0.65071880031086160034,-3.1584613294776686665,1.4752426615328815274,2.7733457150567484284,-2.1992311733251828088,1.9341231235063127691,-2.9352989233795301338,-0.41470059462721836629,3.149963747189258978,-1.2158406236829459868,-2.5205983287523121561,2.5205983287523103797,1.2158406236829486513,-3.1499637471892580898,0.41470059462721287069,2.9352989233795323543,-1.9341231235063065519,-1.9341231235063196525,2.935298923379526137,0.41470059462722952404,-3.1499637471892603102,1.2158406236829435443,2.5205983287523143765,-2.5205983287523023861,-1.2158406236829510938,3.1499637471892558693,-0.41470059462721020616,-2.9352989233795385715,1.9341231235063045535,1.6444956008290994021,-2.9031380428982389574,0.57747006094283337418,2.4611615928788772578,-2.4611615928788714847,-0.57747006094284025757,2.9031380428982398456,-1.6444956008290925187,-1.6444956008291085059,2.903138042898236737,-0.57747006094282637978,-2.4611615928788799224,2.4611615928788705965,0.577470060942852359,-2.9031380428982420661,1.6444956008290865235,1.6444956008291100602,-2.903138042898236737,0.57747006094282460342,2.4611615928788803664,-2.4611615928788697083,-0.57747006094286446043,2.9031380428982442865,-1.6444956008290763094,1.3442511728291910433,-2.6885023456583816426,1.3442511728291888229,1.3442511728291923756,-2.6885023456583816426,1.3442511728291883788,1.344251172829194596,-2.6885023456583816426,1.3442511728291834938,1.3442511728291950401,-2.6885023456583816426,1.3442511728291830497,1.3442511728291959283,-2.6885023456583816426,1.3442511728291823836,1.3442511728291963724,-2.6885023456583816426,1.3442511728291737239,1.3442511728291970385,-2.6885023456583816426,1.3442511728291730577,1.3442511728291977047,-2.6885023456583816426,1.3442511728291726136,1.0474003226641412923,-2.3226341570025765826,1.7804598542985647924,0.15488358661167278552,-1.9690341613300004209,2.2424605130248025375,-0.76121277147921539985,-1.315666563934054345,2.3630668865981880877,-1.5614213855233487482,-0.4620006587262516784,2.1239177479416704308,-2.1239177479416606609,0.46200065872623030661,1.5614213855233711747,-2.3630668865981863114,1.3156665639340363594,0.76121277147922805639,-2.2424605130248114193,1.9690341613299884305,-0.15488358661165738117,-1.7804598542985818899,2.3226341570025721417,-1.0474003226641270814,0.76744877848097059481,-1.8527852494354242197,1.8527852494354235535,-0.76744877848097070583,-0.7674487784809720381,1.8527852494354239976,-1.8527852494354235535,0.76744877848097015072,0.76744877848097270423,-1.852785249435425774,1.8527852494354242197,-0.76744877848096948458,-0.76744877848097337036,1.8527852494354262181,-1.852785249435421111,0.76744877848096204609,0.76744877848096748618,-1.8527852494354235535,1.8527852494354239976,-0.76744877848096804129,-0.76744877848097481365,1.8527852494354266621,-1.852785249435420889,0.76744877848096071382,0.51680875460477049277,-1.3368326581196663394,1.6043525548545252146,-1.2088042586775624709,0.31366523790570349783,0.71110953022609291185,-1.4419874801413083976,1.5769016378304014925,-1.0600928832256264478,0.10515482202163914383,0.89324302462844007433,-1.5224694965832692439,1.5224694965832661353,-0.89324302462843219175,-0.1051548220216485946,1.0600928832256335532,-1.5769016378304030468,1.4419874801413039567,-0.71110953022608203167,-0.31366523790570993713,1.2088042586775704645,-1.6043525548545256587,1.336832658119659456,-0.51680875460476427552,};

kiss_fftr_cfg cfg = NULL;
kiss_fft_cfg cfg_i = NULL;
kiss_fftr_cfg cfg_2 = NULL;
kiss_fftr_cfg cfg_2_i = NULL;
int identity;


void printArray(double* in, int len){
	for(int i = 0; i < len;i++)	LOGD("data%d: %f", i,in[i]);
}

int getFrameFeature( double * data, double * hanning,int frameIndex, int frame_length, int fft_length, int mfcc_length, double * feature) {
	///////////////////////////////////////////////////////	
	double sample[frame_length];
	double cepstrum[frame_length];
	kiss_fft_cpx freq[fft_length];
	double fft[fft_length]; 
    double energySpec[fft_length];
	double sumfft = 0;
	double sumEnerySpec = 0;
	double pitch = 0;
	double specEntropy = 0;
	//double specFlux = 0;
	double specCentroid = 0;
	double hfr = 0;
	double bankPass[NBANK];
	double mfcc[NMFCC];
	//double bandwidth = 0;
	//use a huge number here.
	//static double lastfft[MAX_FFT];
	//benchmark timer
	//time_t timeStamp[10];
	//struct timeval tv[10];	
		//timeStamp[0] = clock();
		//gettimeofday(&tv[0], NULL);
		//printf("audio processing %d,%d\n",frame_length,data[511]);     
	//LOGD("Hello JNI\n");
		for(int i=0;i<frame_length;i++){
			//if(frameIndex < 5)printf("%d,",*(s+i));
			//printf("%d,",*(s+i));
			sample[i] = (*(data+i))*hanning[i];
			//rms += (*(data+i))*(*(data+i));
		}
		//feature[0] = sqrt(rms/frame_length);
                //printf("rms %f,",rms_history[frameIndex % window_length]);
		//if(!cfg) initFFT();
		kiss_fftr(cfg, sample, freq);

		//********************** discard dc, i start from 1 ********************************
		for(int i = 0;i<fft_length;i++){
			energySpec[i] = (double)(freq[i].i*freq[i].i+freq[i].r*freq[i].r);
			fft[i] = sqrt(energySpec[i]);
			if(fft[i] < 0.00000000000000000001){
				fft[i] = 0.00000000000000000001;
			}
			cepstrum[i] = log(fft[i]);
			if (i>=1){
				sumfft += fft[i];
				sumEnerySpec += energySpec[i];
				cepstrum[ frame_length - i ] = cepstrum[i];
			}
		}
		
		double lowSum = 0;
		for(int i = 1; i<=LOW_FREQ; i++){
			lowSum += fft[i];
		}
		hfr = lowSum/(sumfft-lowSum);
		
		
		
		kiss_fftr(cfg, cepstrum, freq);
		{//pitch
			double max = 0;
			int ind = 0;
			for(int i = (PITCH_MIN - 1);i<PITCH_MAX;i++){
				//LOGD("r: %f", freq[i].r);
				//LOGD("i: %f", freq[i].i);
				if(freq[i].r>max){				
					max = freq[i].r;
					ind = i;
				}
			}
			pitch = FS/(1 + ind);
		}
		
		/*
		 for(int i=0;i<fft_length;i++){
		 if(DEBUG) printf("%f,",energySpec[i]);
		 }
		 if(DEBUG) printf("\n");		
		 */
		//////////////////////////// mfcc calculation ////////////////////////////////////		
		//gettimeofday(&tv[2], NULL);
		//double* mf = calculateMfcc(energySpec);
		//mfcc calculation.
		for(int i = 0;i< NBANK;i++){
			bankPass[i] = 0; 
			for(int j = filterInd[i][0]; j <=filterInd[i][1]; j++){
				bankPass[i] += fft[j-1] * bankFilter[i][j-1];				
			}
			bankPass[i] = log10(bankPass[i]);
		}
		//actually we can start from i = 1
		for(int i = 0;i< NMFCC;i++){
			mfcc[i] = 0; 
			for(int j = 0; j < NBANK; j++){
				mfcc[i] += bankPass[j] * dct[i][j];				
			}
		}
		memcpy(feature+6,mfcc,sizeof(double)*NMFCC);
		
		
		
		//memcpy(feature+6, mf, sizeof(double)*mfcc_length);
		//gettimeofday(&tv[3], NULL);
		 /*
		 for(int i = 0;i<mfcc_length;i++){
		 printf("%f,",mf[i]);
		 }
		 printf("\n");
		*/
		//fft[],and spectralenenry[] are normalized
		///////////////////////////////////////////////////////////////////////////////////
		
		for(int i=1;i<fft_length;i++){
			fft[i] = fft[i]/sumfft;
			energySpec[i] = energySpec[i]/sumEnerySpec;
		}
		//reuse sumfft for roll off
		/*
		sumfft = 0;
		for(int i=1;i<fft_length;i++){
			sumfft += fft[i];
			if( sumfft >= 0.93 ){
				rolloff = i;
				feature[1] = rolloff;
				break;
			}
		}
		*/
		
			for(int i=1;i<fft_length;i++){
				specEntropy -= fft[i]*log(fft[i]);
				specCentroid += i*energySpec[i];
			}

			feature[0] = specEntropy;
			feature[1] = specCentroid;
			feature[2] = pitch;
			feature[3] = hfr;
			//if(DEBUG) printf("%f,%f\n",specFlux,specCentroid);
		
		/*
		//keep history
		if( frameIndex==0 ){
			for(int i = 1;i<fft_length;i++){
				lastfft[i] = fft[i];
			}
		}else{
			for(int i=1;i<fft_length;i++){
				lastfft[i] = fft[i]*0.05 +lastfft[i]*0.95;
			}
		}
		*/
        //printf("rms %f\n",rms_history[frameIndex % window_length]);
		//timeStamp[4] = clock();
		//gettimeofday(&tv[4], NULL);
		//right now step can only be 1/2 window or window.
		if(feature[0]>4.1) return 0;
		return 1;
}

void initFFT(int id){
   if(!cfg) cfg = kiss_fftr_alloc(NFFT,0, NULL, NULL);
   if(!cfg_i) cfg_i = kiss_fft_alloc(NFFT,1, NULL, NULL);
   if(!cfg_2) cfg_2 = kiss_fftr_alloc(NFFT*2,0, NULL, NULL);
   if(!cfg_2_i) cfg_2_i = kiss_fftr_alloc(NFFT*2,1, NULL, NULL);
   identity = id;
}

void delFFT(int id){
	if(id != identity) return;
	if(cfg) free(cfg); 
	if(cfg_i) free(cfg_i); 
	if(cfg_2) free(cfg_2);
	if(cfg_2_i) free(cfg_2_i);
}

void getTeager(double * data, int numBank, int frameLength, double * out){
	double * start;
	double tmp[NFFT*2] = {0};
	kiss_fft_cpx freq0[NFFT/2+1];
	kiss_fft_cpx freq[NFFT+1];
	kiss_fft_cpx freq2[NFFT];
	kiss_fft_cpx freq3[NFFT];
	double corr[NFFT*2];
	double env[NFFT];
	//memset(tmp,0,sizeof(tmp));
	//printArray(tmp,NFFT*2);
	//if(!cfg) initFFT();

	for(int i = 0; i< numBank; i++){		
		start = data + i * frameLength;
		//printArray(start,20);
		//LOGD("r: %d", start);
		memcpy(tmp,start,sizeof(double) * frameLength);
		//printArray(tmp,NFFT*2);
		kiss_fftr(cfg_2, tmp, freq);
		//********************** discard dc, i start from 1 ********************************
		for(int j = 0;j<NFFT+1;j++){
			//if(j < 10)LOGD("r: DC r %f", freq[j].r);
			//if(j < 10)LOGD("r: DC i %f", freq[j].i);
			freq[j].r = (freq[j].i*freq[j].i+freq[j].r*freq[j].r);
			freq[j].i = 0.0;
			//if(j < 10) LOGD("%d r: %.20f,%.20f", j,freq[j].r,freq[j].i);
		}
		kiss_fftri(cfg_2_i, freq, corr);
		if(corr[0]<1e-10) corr[0]=1e-10; 
		double temp = corr[0];
		for(int j = 0;j<NFFT;j++){
			corr[j] /= temp;
		}
		//printArray(corr,NFFT*2);
		//printArray(corr,5);
		//hilbert
		kiss_fftr(cfg,corr,freq0);
		memset(freq2,0,sizeof(freq2));
		freq2[0] = freq0[0];
		freq2[NFFT/2] = freq0[NFFT/2];
		for(int j = 1; j<NFFT/2;j++){
			freq2[j].i = freq0[j].i * 2;
			freq2[j].r = freq0[j].r * 2;
		}
		//LOGD("freq2 %d: %.20f %.20f", 0,freq2[0].r,freq2[0].i);
		//LOGD("freq2 %d: %.20f %.20f", 1,freq2[1].r,freq2[1].i);
		//LOGD("freq2 %d: %.20f %.20f", 2,freq2[2].r,freq2[2].i);
		//LOGD("freq2 %d: %.20f %.20f", 254,freq2[254].r,freq2[254].i);
		//LOGD("freq2 %d: %.20f %.20f", 255,freq2[255].r,freq2[255].i);
		//LOGD("freq2 %d: %.20f %.20f", 128,freq2[128].r,freq2[128].i);
		
		kiss_fft(cfg_i,freq2,freq3);
		out[i] = 0 ;
		for(int j = 0;j<NFFT;j++){
				out[i] += sqrt(freq3[j].i*freq3[j].i+freq3[j].r*freq3[j].r)/NFFT_SQUARE;
		}
		//LOGD("out %d: %.20f", i,out[i]);	
	}
}



void getWindowFeature(int window_length, int frameIndex, int mfcc_length, double * se_history, double * sf_history, double * sc_history, double * ro_history, double * bw_history, double * mfcc_history, double * rms_history, double * feature){
			double semean = 0;
			double sev = 0;
			double sfmean = 0;
			double sfv = 0;
			double scmean = 0;
			double scv = 0;
			double romean = 0;
			double rov = 0;
			double bwmean = 0;
			double bwv = 0;
			double rmsmean = 0;
			double rmsv = 0;
			double lowenergy = 0;
			double pr[9];
			//double entmean = 0;
			//double entv = 0;
			int result = 0;
			//maxTuple m;
			//printf("enter-------------\n", rmsmean,rmsv);			
			variance(rms_history,window_length, &rmsmean,&rmsv);
			//printf("%f,%f,slience\n", rmsmean,rmsv);
			variance(se_history, window_length, &semean, &sev);
			variance(sf_history, window_length, &sfmean, &sfv);
			variance(sc_history, window_length, &scmean, &scv);
			variance(ro_history, window_length, &romean, &rov);
			variance(bw_history, window_length, &bwmean, &bwv);
			
			/*
			for(int i=0; i<window_length; i++){
				if(DEBUG) LOGD("se: %f", se_history[i]*10e17);				
			}
  			if(DEBUG) LOGD("se: %f,%f", semean*10e17,sev*10e17);
			*/
			double tmp =  rmsmean*0.5;
			for(int i=0;i<window_length;i++){
				if(rms_history[i]<=tmp)lowenergy++;
			}
			
			feature[0] = semean;feature[1] = sev; feature[2] = sfmean;feature[3] = sfv; 
			feature[4] = romean;feature[5] = rov; feature[6] = scmean; feature[7] = scv; 
			feature[8] = bwmean; feature[9] = bwv; feature[10] = lowenergy;
			//timeStamp[5] = clock();
			//gettimeofday(&tv[5], NULL);
			memcpy(feature+11, mfcc_history + (frameIndex % window_length)*mfcc_length + 1, sizeof(double)*(mfcc_length-1));
			feature[24] = rmsmean;
}
